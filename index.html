<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Idle Game</title>
    <style>
        body
        {
            font-family: sans-serif;
            background: #222;
            color: #eee;
            padding: 20px;
        }

        .stats-container {
            display: flex;
            gap: 20px; /* Adds spacing between the divs */
        }

        .section
        {
            flex: 1;
            margin-bottom: 20px;
            padding: 10px;
            background: #333;
            border-radius: 10px;
        }

        .button
        {
            margin: 2px;
            padding: 8px;
            background: #444;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .button:hover
        {
            background: #666;
        }

    </style>
</head>
<body>
    <h1>Idle Game</h1>

    <div class="stats-container">
        <div class="section" id="stats">
            <h2>Resources</h2>
            <p>Food: <span id="food">0</span> / <span id="maxFood">0</span></p>
            <p>Wood: <span id="wood">0</span> / <span id="maxWood">0</span></p>
            <p id="metalStats" style="display: none;">Metal: <span id="metal">0</span> / <span id="maxMetal">0</span></p>
            <p>Population: <span id="population">0</span> / <span id="maxPopulation">0</span></p>
        </div>

        <div class="section" id="buildingsinfo">
            <h2>Buildings</h2>
            <p>Farm: <span id="farm">0</span> (+ Max Food)</p>
            <p>Barn: <span id="barn">0</span> (+ Max Wood)</p>
            <p id="houseBuildings" style="display: none;">House: <span id="house">0</span> (+ Max Population)</p>            
            <p id="mineBuildings" style="display: none;">Mine: <span id="mine">0</span></p>
            <p id="barracksBuildings" style="display: none;">Barracks: <span id="barracks">0</span></p>
        </div>
    </div>

    <div class="section" id="gathering">
        <h2>Gather Resources</h2>
        <button class="button" id="buttonFood" onclick="playerStartGathering('food')">Gather Food</button>
        <button class="button" id="buttonWood" onclick="playerStartGathering('wood')">Gather Wood</button>
        <button class="button" id="buttonMetal" style="display: none;" onclick="playerStartGathering('metal')">Gather Metal</button>
    </div>

    <div class="section" id="buildingsbuttons">
        <h2>Buy Buildings</h2>
        <button class="button" onclick="buildFarm()">Build Farm (100 Food, 100 Wood)</button>
        <button class="button" onclick="buildBarn()">Build Barn (100 Food, 100 Wood)</button>        
        <button class="button" id="houseButton" style="display: none;" onclick="buildHouse()">Build House (100 Wood)</button>
        <button class="button" id="mineButton" style="display: none;" onclick="buildMine()">Build Mine (300 Food, 300 Wood)</button>
        <button class="button" id="barracksButton" style="display: none;" onclick="buildBarracks()">Build Barracks (300 Food, 300 Wood, 300 Metal)</button>
    </div>

    <div class="section" id="assignments">
        <h2>Assign Population</h2>
        <p>Available workers: <span id="availableWorkers">0</span></p>
        <p>Farm Workers: <button class="button" onclick="changeAssignment('farm', -1)">-</button> <span id="farmWorkers">0</span> <button class="button" onclick="changeAssignment('farm', 1)">+</button></p>
        <p>Population Workers: <button class="button" onclick="changeAssignment('pop', -1)">-</button> <span id="popWorkers">0</span> <button class="button" onclick="changeAssignment('pop', 1)">+</button></p>
        <p>Timber Workers: <button class="button" onclick="changeAssignment('wood', -1)">-</button> <span id="woodWorkers">0</span> <button class="button" onclick="changeAssignment('wood', 1)">+</button></p>
        <p id="minersSection" style="display: none;">Miners: <button class="button" onclick="changeAssignment('metal', -1)">-</button> <span id="metalWorkers">0</span> <button class="button" onclick="changeAssignment('metal', 1)">+</button></p>
        <p id="militarySection" style="display: none;">Military: <button class="button" onclick="changeAssignment('military', -1)">-</button> <span id="militaryWorkers">0</span> <button class="button" onclick="changeAssignment('military', 1)">+</button></p>
    </div>

    <script>
        let food = 50;
        let maxFood = 100;
        let wood = 0;
        let maxWood = 100;
        let metal = 0;
        let maxMetal = 100;
        let swords = 0;

        let population = 2;
        let maxPopulation = 5;

        let playerGatherAmount = 3;

        let assignments = {
            farm: 0,
            pop: 0,
            wood: 0,
            metal: 0,
            swords: 0,
            military: 0
        };

        let ownedBuildings = {
            barn: 0,
            house: 0,
            farm: 0,
            mine: 0,
            barracks: 0
        }

        let unlocks = {
            barn: true,
            house: false,
            farm: true,
            mine: false,
            miners: false,
            battle: false,
            barracks: false,
            swords: false
        }

        let availableWorkers = population;

        let totalTicks = 0;

        let playerIsCurrentlyGathering = false;
        let whatIsCurrentlyGathering = "";
        let gatheringInterval = 3000; // 3 seconds
        let lastGatheringTime = 0;

        

        function tickPlayerGather(type) // player gathers resouces
        {
            if (type === "" || !playerIsCurrentlyGathering)
            {
                return;
            }
            let currentTime = new Date().getTime();
            if (currentTime - lastGatheringTime >= gatheringInterval)
            {
                lastGatheringTime = currentTime;

                if (type === "food" && food + playerGatherAmount <= maxFood)
                {
                    food += playerGatherAmount;
                }
                else if (type === "wood" && wood + playerGatherAmount <= maxWood)
                {
                    wood += playerGatherAmount;
                }
                else if (type === "metal" && metal + playerGatherAmount <= maxMetal)
                {
                    metal += playerGatherAmount;
                }
                
            }

        }

        function playerStartGathering(type)
        {
            if (playerIsCurrentlyGathering)
            {
                if (whatIsCurrentlyGathering === type)
                {
                    // Stop gathering the current resource
                    console.log("Player stopped gathering " + type);
                    document.getElementById("button" + type.charAt(0).toUpperCase() + type.slice(1)).style.background = "#444";
                    document.getElementById("button" + type.charAt(0).toUpperCase() + type.slice(1)).textContent = "Gather " + type;
                    playerIsCurrentlyGathering = false;
                    whatIsCurrentlyGathering = "";
                }
                else
                {
                    // Switch to gathering a different resource
                    console.log("Player switched to gathering " + type);
                    document.getElementById("button" + whatIsCurrentlyGathering.charAt(0).toUpperCase() + whatIsCurrentlyGathering.slice(1)).style.background = "#444";
                    document.getElementById("button" + whatIsCurrentlyGathering.charAt(0).toUpperCase() + whatIsCurrentlyGathering.slice(1)).textContent = "Gather " + whatIsCurrentlyGathering;

                    document.getElementById("button" + type.charAt(0).toUpperCase() + type.slice(1)).style.background = "#666";
                    document.getElementById("button" + type.charAt(0).toUpperCase() + type.slice(1)).textContent = "Stop gathering " + type;
                    whatIsCurrentlyGathering = type;
                }
            }
            else
            {
                // Start gathering a resource
                console.log("Player started gathering " + type);
                document.getElementById("button" + type.charAt(0).toUpperCase() + type.slice(1)).style.background = "#666";
                document.getElementById("button" + type.charAt(0).toUpperCase() + type.slice(1)).textContent = "Stop gathering " + type;
                playerIsCurrentlyGathering = true;
                whatIsCurrentlyGathering = type;
            }
        }

        function buildBarn()
        {
            if (food >= 100 && wood >= 100)
            {
                ownedBuildings.barn += 1;
                
                food -= 100;
                wood -= 100;
                maxWood = maxWood * 2;
                updateDisplay();
            }
        }

        function buildHouse()
        {
            if (wood >= 100)
            {
                ownedBuildings.house += 1;

                wood -= 100;
                maxPopulation += 2;
                updateDisplay();
            }
        }

        function buildFarm()
        {
            if (food >= 100 && wood >= 100)
            {
                ownedBuildings.farm += 1;
                food -= 100;
                wood -= 100;
                maxFood = maxFood * 2;
                updateDisplay();
            }
        }

        function buildMine()
        {
            if (food >= 300 && wood >= 300)
            {
                ownedBuildings.mine += 1;
                food -= 300;
                wood -= 300;
                maxMetal = maxMetal * 2;

                if(!unlocks.miners)
                {
                    unlocks.miners = true;
                    playerUnlock("miners");
                }
                
                updateDisplay();
            }
        }

        function buildBarracks()
        {
            if (food >= 300 && wood >= 300 && metal >= 300)
            {
                food -= 300;
                wood -= 300;
                metal -= 300;
                ownedBuildings.barracks += 1;
                maxPopulation += 5;

                if(!unlocks.military)
                {
                    unlocks.military = true;
                    playerUnlock("military");
                }

                updateDisplay();
            }
        }

        function changeAssignment(type, amount)
        {
            if (amount > 0 && availableWorkers >= amount)
            {
                assignments[type] += 1;
                availableWorkers -= 1; // Do this so the player action is instant in the GUI, the actual amount will be set at each tick
            }
            else if (amount < 0 && assignments[type] > 0)
            {
                assignments[type] -= 1;
                availableWorkers += 1;
            }

            updateDisplay();
        }

        function tickIncrementMaterials() // Increments materials based on assignments
        {
            if (food + assignments.farm > maxFood)
            {
                food = maxFood;
            }
            if (wood + assignments.wood > maxWood)
            {
                wood = maxWood;
            }
            if (metal + assignments.metal > maxMetal)
            {
                metal = maxMetal;
            }
            if (food + assignments.farm <= maxFood)
            {
                food += assignments.farm;
            }
            if (wood + assignments.wood <= maxWood)
            {
                wood += assignments.wood;
            }
            if (metal + assignments.metal <= maxMetal)
            {
                metal += assignments.metal;
            }
        }

        function tickCheckForGameOver()
        {
            if(population === 0)
            {
                alert("Game over! You have no population left.");
                location.reload();
            }
        }

        function tickUpdateFoodAndPopulation() // Updates food and population every 10 ticks
        {
            if (totalTicks % 10 === 0 && totalTicks > 9)
            {
                if (food - population >= 0)
                {
                    console.log("Food decreases by: " + population);
                    food -= population;
                }
                else
                {
                    console.log("Food decreases by: " + food);
                    food = 0;
                }
                if (population < maxPopulation && assignments.pop >= 2 && food > 0)
                {
                    let newPopulation = Math.ceil(assignments.pop / 2);
                    if(newPopulation + population > maxPopulation) // goes over limit, set to max
                    {
                        newPopulation = maxPopulation - population;
                    }
                    console.log("Population increases by: " + newPopulation);
                    population += newPopulation;
                }
            }
        }

        function tickCheckForUnlocks() // Checks if the player has unlocked new things
        {
            if(population >= 5 && unlocks.house == false)
            {
                playerUnlock("house");
            }

            if (maxPopulation >= 10 && unlocks.mine == false)
            {
                playerUnlock("mine");
            }

            if (maxPopulation >= 20 && metal >= 200 && unlocks.barracks == false)
            {
                playerUnlock("barracks");
            }
        }

        function playerUnlock(type)
        {
            switch (type)
            {
                case "house":
                    unlocks.house = true;
                    document.getElementById("houseButton").style.display = "inline-block";
                    document.getElementById("houseBuildings").style.display = "inline-block";
                    document.getElementById("houseBuildings").style.width = "100%";
                    break;

                case "mine":
                    unlocks.mine = true;
                    document.getElementById("mineButton").style.display = "inline-block";
                    break;
                
                case "miners":
                    unlocks.metal = true;
                    document.getElementById("mineBuildings").style.display = "inline-block";
                    document.getElementById("mineBuildings").style.width = "100%";                
                    document.getElementById("metalStats").style.display = "inline-block";
                    document.getElementById("buttonMetal").style.display = "inline-block";
                    document.getElementById("minersSection").style.display = "inline-block";
                    document.getElementById("minersSection").style.width = "100%";  
                    break;

                case "barracks":
                    unlocks.barracks = true;
                    document.getElementById("barracksButton").style.display = "inline-block";
                    document.getElementById("barracksBuildings").style.display = "inline-block";
                    document.getElementById("barracksBuildings").style.width = "100%";                    
                    break;
                
                case "military":
                    unlocks.military = true;
                    document.getElementById("militarySection").style.display = "inline-block";
                    document.getElementById("militarySection").style.width = "100%";
                    break;
            }
        }

        function tickCheckStarvation() // Checks if the player has enough food to feed the population
        {
            if (food === 0)
            {
                if (population > 0) // reduce population
                {
                    console.log("Population decreases by 1");
                    population -= 1;

                    if ((assignments.farm + assignments.pop + assignments.wood + assignments.metal) > 0) // reduce workers
                    {
                        const assignmentKeys = Object.keys(assignments);
                        let attempts = 0;
                        const checkedKeys = [];

                        while (attempts < assignmentKeys.length)
                        {
                            const randomIndex = Math.floor(Math.random() * assignmentKeys.length);
                            const randomKey = assignmentKeys[randomIndex];

                            if (checkedKeys.includes(randomKey)) // already checked this key
                            {
                                continue; // next key without incrementing attempts
                            }

                            checkedKeys.push(randomKey);

                            if (assignments[randomKey] > 0)
                            {
                                console.log("Random assignment decreases by 1: " + randomKey);
                                assignments[randomKey] -= 1;
                                break;
                            }

                            attempts++;
                        }
                    }
                }
            }
        }

        function tick()
        {
            tickCheckForGameOver();
            tickIncrementMaterials();
            tickUpdateFoodAndPopulation();
            tickCheckForUnlocks();
            tickPlayerGather(whatIsCurrentlyGathering)
            tickCheckStarvation();

            availableWorkers = population - (assignments.farm + assignments.pop + assignments.wood + assignments.metal);

            updateDisplay();
            totalTicks += 1;
        }

        function updateDisplay()
        {
            // Materials
            document.getElementById("food").textContent = food;
            document.getElementById("maxFood").textContent = maxFood;
            document.getElementById("wood").textContent = wood;
            document.getElementById("maxWood").textContent = maxWood;
            document.getElementById("metal").textContent = metal;
            document.getElementById("maxMetal").textContent = maxMetal;

            // Buildings
            document.getElementById("barn").textContent = ownedBuildings.barn;
            document.getElementById("house").textContent = ownedBuildings.house;
            document.getElementById("farm").textContent = ownedBuildings.farm;
            document.getElementById("mine").textContent = ownedBuildings.mine;
            document.getElementById("barracks").textContent = ownedBuildings.mine;

            // Population
            document.getElementById("population").textContent = population;
            document.getElementById("maxPopulation").textContent = maxPopulation;

            // Assignments
            document.getElementById("availableWorkers").textContent = availableWorkers;
            document.getElementById("farmWorkers").textContent = assignments.farm;
            document.getElementById("popWorkers").textContent = assignments.pop;
            document.getElementById("woodWorkers").textContent = assignments.wood;
            document.getElementById("metalWorkers").textContent = assignments.metal;
            document.getElementById("militaryWorkers").textContent = assignments.metal;
        }

        setInterval(tick, 1000);
    </script>
</body>
</html>
